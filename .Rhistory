TRUE ~ 0))%>%
select(sample_label, site, side_of_state, species, stage, value_1, value_2, value_3, positive_status) %>%
group_by(sample_label) %>%
mutate(singles=1) %>%
pivot_longer(cols=c(value_1, value_2, value_3),
names_to="replicate",
values_to="virus_copies") %>%
mutate(stage=case_when(stage=="adult"~"adult",
TRUE ~ "juvenile"))
View(develop)
#Total positive by stage
stage_pos_total <- develop %>%
group_by(stage) %>%
mutate(total_pos=sum(positive_status)) %>%
mutate(total_ind=sum(singles)) %>%
ungroup()
#Prevalence by stage from scratch
prev_stage <- stage_pos_total %>%
group_by(stage) %>%
mutate(prevalence=((sum(positive_status)/(sum(singles)))*100))
#model
species_site_model <- brm(virus_copies ~ 1+ site*species,
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept")),
#sample_prior="only",
iter=2000, chains=4,
file="Models/species_site_model.rds",
file_refit="on_change")
#Data for plotting
cond_data_site <- distinct(species_site_model$data %>% select(-virus_copies))
posts_site <- add_epred_draws(species_site_model, newdata=cond_data_site, dpar=TRUE) %>%
mutate(epred_hu=.epred*hu)
saveRDS(species_site_model, "Models/species_site_model.rds")
#Plot looking at the copies of ranavirus on the log scale based on species, colored by site, using the corrected virus value calculated by multiplying the probability of detection by the number of virus copies.
species_site_plot <- posts_site %>%
ggplot(aes(x=site, y=.epred, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=species_site_model$data, aes(y=average_virus),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(size=8, angle=30, hjust=1))+
guides(fill=guide_legend(title="Species"))
species_site_plot
#Plot looking at the copies of ranavirus on the log scale based on species, colored by site, using the corrected virus value calculated by multiplying the probability of detection by the number of virus copies.
species_site_plot <- posts_site %>%
ggplot(aes(x=site, y=.epred, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data$data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(size=8, angle=30, hjust=1))+
guides(fill=guide_legend(title="Species"))
species_site_plot
#Plot looking at the copies of ranavirus on the log scale based on species, colored by site, using the corrected virus value calculated by multiplying the probability of detection by the number of virus copies.
species_site_plot <- posts_site %>%
ggplot(aes(x=site, y=.epred, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data$data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(size=8, angle=30, hjust=1))+
guides(fill=guide_legend(title="Species"))
species_site_plot
posts_site %>%
ggplot(aes(x=site, y=epred_hu, fill=species))+
geom_violin()
posts_site %>%
ggplot(aes(x=site, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data$data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()
posts_site %>%
ggplot(aes(x=site, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()
#Plot looking at the copies of ranavirus on the log scale based on species, colored by site, using the corrected virus value calculated by multiplying the probability of detection by the number of virus copies.
species_site_plot <- posts_site %>%
ggplot(aes(x=site, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(size=8, angle=30, hjust=1))+
guides(fill=guide_legend(title="Species"))
species_site_plot
species_site_plot
posts_site
exp(0.3)
inv_logit_scaled(0.3)
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept")),
#sample_prior="only",
iter=2000, chains=4,
file="Models/species_site_model.rds",
file_refit="on_change")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept")),
#sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
saveRDS(species_site_model, "Models/species_site_model.rds")
species_site_model#call the model to view stats
#Data for plotting
cond_data_site <- distinct(species_site_model$data %>% select(-virus_copies))
posts_site <- add_epred_draws(species_site_model, newdata=cond_data_site, dpar=TRUE) %>%
mutate(epred_hu=.epred*hu)
#Plot looking at the copies of ranavirus on the log scale based on species, colored by site, using the corrected virus value calculated by multiplying the probability of detection by the number of virus copies.
species_site_plot <- posts_site %>%
ggplot(aes(x=site, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(size=8, angle=30, hjust=1))+
guides(fill=guide_legend(title="Species"))
species_site_plot
library(tidyverse)
library(brms)
library(readxl)
library(tidybayes)
#Load the data
data <- read_excel("2021_State_Ranavirus_Data.xlsx",
col_types = c("text", "text", "text",
"text", "text", "text", "numeric",
"text", "text", "text", "numeric",
"numeric", "numeric", "skip", "text"))
head(data)
#Adding a column to the data where positives are given a 1, negatives a 0, then selecting the necessary columns and calculating the average copies of virus per individual
# site_based_pos <- data %>%
#   mutate(positive_status=case_when(result=="positive" ~ 1,
#                             TRUE ~ 0))%>%
#   #filter(value_1>0) %>%
#   select(sample_label, site, side_of_state, species, value_1, value_2, value_3, positive_status) %>%
#   group_by(sample_label) %>%
#   mutate(average_virus=mean(c(value_1, value_2, value_3))) %>%
#   mutate(singles=1) %>%
#   pivot_longer(cols=c(value_1, value_2, value_3),
#                names_to="replicate",
#                values_to="virus_copies")
site_data <- data %>%
mutate(positive_status=case_when(result=="positive" ~ 1)) %>%
select(sample_label, site, side_of_state, species, value_1, value_2, value_3, positive_status) %>%
pivot_longer(cols=c(value_1, value_2, value_3),
names_to="replicate",
values_to="virus_copies")
#Doing the same as above but now incorporating development stage
develop <- data %>%
mutate(positive_status=case_when(result=="positive" ~ 1,
TRUE ~ 0))%>%
select(sample_label, site, side_of_state, species, stage, value_1, value_2, value_3, positive_status) %>%
group_by(sample_label) %>%
mutate(singles=1) %>%
pivot_longer(cols=c(value_1, value_2, value_3),
names_to="replicate",
values_to="virus_copies") %>%
mutate(stage=case_when(stage=="adult"~"adult",
TRUE ~ "juvenile"))
#cold_brook_prevalence <- site_based_pos %>%
#  filter(site=="cold_brook_lake") %>%
# summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
# mutate(total=sum(prevalence)) %>%
# view()
#
# NAB_2_prevalence <- site_based_pos %>%
#   filter(site=="NAB_2") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# cottonwood_springs_prevalence <- site_based_pos %>%
#   filter(site=="cottonwood_springs_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# yankton_1_prevalence <- site_based_pos %>%
#   filter(site=="yankton_1") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# yankton_2_prevalence <- site_based_pos %>%
#   filter(site=="yankton_2") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# lost_lake_prevalence <- site_based_pos %>%
#   filter(site=="lost_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# acheson_prevalence <- site_based_pos %>%
#   filter(site=="acheson") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# buffalo_lake_prevalence <- site_based_pos %>%
#   filter(site=="buffalo_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# gold_run_creek_prevalence <- site_based_pos %>%
#   filter(site=="gold_run_creek") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# habeger_prevalence <- site_based_pos %>%
#   filter(site=="habeger") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# horsethief_prevalence <- site_based_pos %>%
#   filter(site=="horsethief") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# iron_creek_lake_prevalence <- site_based_pos %>%
#   filter(site=="iron_creek_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# long_lake_prevalence <- site_based_pos %>%
#   filter(site=="long_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# mitchell_lake_prevalence <- site_based_pos %>%
#   filter(site=="mitchell_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# pettigrew_prevalence <- site_based_pos %>%
#   filter(site=="pettigrew") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# roubaix_lake_prevalence <- site_based_pos %>%
#   filter(site=="roubaix_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#
# sylvan_lake_prevalence <- site_based_pos %>%
#   filter(site=="sylvan_lake") %>%
#   summarize(prevalence=sum(average_virus>0)/nrow(.)) %>%
#   mutate(total=sum(prevalence)) %>%
#   view()
#Total positive individuals by site
total_pos <- site_based_pos %>%
group_by(site) %>%
mutate(total_positive=sum(positive_status)) %>%
mutate(total_individuals=sum(singles)) %>%
ungroup()
#Total positive individuals by site
total_pos <- site_data %>%
group_by(site) %>%
mutate(total_positive=sum(positive_status)) %>%
mutate(total_individuals=sum(singles)) %>%
ungroup()
#Total positive by stage
stage_pos_total <- develop %>%
group_by(stage) %>%
mutate(total_pos=sum(positive_status)) %>%
mutate(total_ind=sum(singles)) %>%
ungroup()
#Prevalence by stage from scratch
prev_stage <- stage_pos_total %>%
group_by(stage) %>%
mutate(prevalence=((sum(positive_status)/(sum(singles)))*100))
get_prior(virus_copies ~ 1+ site*species, data=site_data, family=hurdle_gamma(link="log"))
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept")),
#sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
saveRDS(species_site_model, "Models/species_site_model.rds")
species_site_model#call the model to view stats
#Conditional effects plot
plot(conditional_effects(species_site_model), points=T)
#Data for plotting
cond_data_site <- distinct(species_site_model$data %>% select(-virus_copies))
posts_site <- add_epred_draws(species_site_model, newdata=cond_data_site, dpar=TRUE) %>%
mutate(epred_hu=.epred*hu)
#Adding dpar=TRUE creates the column hu which contains the probability of detecting 0 ranavirus copies.
#Plot looking at the copies of ranavirus on the log scale based on species, colored by site, using the corrected virus value calculated by multiplying the probability of detection by the number of virus copies.
species_site_plot <- posts_site %>%
ggplot(aes(x=site, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1,aes(fill=species), position=position_dodge(width=0.9), outlier.size=0)+
geom_point(data=site_data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(size=8, angle=30, hjust=1))+
guides(fill=guide_legend(title="Species"))
species_site_plot
ggsave("site_species_interaction_plot.jpg", plot=species_site_plot,width=6, height=4, dpi=600)
#Plot looking at the average copies of ranavirus on the log scale based on species
species_plot <- posts_site %>%
ggplot(aes(x=species, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1, alpha=0.6, outlier.size=0)+
geom_point(data=species_site_model$data, aes(y=virus),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Average Ranavirus Copies", x="Species")+
theme(axis.text.x=element_text(angle=30, hjust=1))
species_plot
#Plot looking at the average copies of ranavirus on the log scale based on species
species_plot <- posts_site %>%
ggplot(aes(x=species, y=epred_hu, fill=species))+
geom_violin()+
geom_boxplot(width=0.1, alpha=0.6, outlier.size=0)+
geom_point(data=species_site_model$data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Average Ranavirus Copies", x="Species")+
theme(axis.text.x=element_text(angle=30, hjust=1))
species_plot
#Plot looking at the average copies of ranavirus on the log scale based on site
site_plot <- posts_site %>%
ggplot(aes(x=site, y=.epred))+
geom_violin(fill='#A4A4A4')+
geom_boxplot(width=0.1, alpha=0.6, outlier.size=0)+
geom_point(data=species_site_model$data, aes(y=virus),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Average Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(angle=30, hjust=1))
#Plot looking at the average copies of ranavirus on the log scale based on site
site_plot <- posts_site %>%
ggplot(aes(x=site, y=.epred))+
geom_violin(fill='#A4A4A4')+
geom_boxplot(width=0.1, alpha=0.6, outlier.size=0)+
geom_point(data=species_site_model$data, aes(y=virus_copies),
position=position_dodge(width=0.9))+
scale_y_log10()+
labs(y="Average Ranavirus Copies", x="Site")+
theme(axis.text.x=element_text(angle=30, hjust=1))
site_plot
#posterior predictive check graphs
pp_check(species_site_model, type="stat_grouped", group="species")
pp_check(species_site_model, type="stat_grouped", group="site")
get_prior(virus_copies ~ 1+ site*species, data=site_data, family=hurdle_gamma(link="log"))
file_refit="on_change")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(beta(1,1), class="hu")),
sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept")),
sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept")),
sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(beta(1,1), class="hu")),
sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(normal(0,0.5), class="hu")),
sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
get_prior(virus_copies ~ 1+ site*species, data=site_data, family=hurdle_gamma(link="log"))
#posterior predictive check graphs
pp_check(species_site_model, type="stat_grouped", group="species")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(normal(0.2, 0.5), class="b", coef="speciesanaxyrus_woodhousii"),
prior(normal(0.2, 0.5), class="b", coef="speciesacris_blanchardi")),
#sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
get_prior(virus_copies ~ 1+ site*species, data=site_data, family=hurdle_gamma(link="log"))
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0.1, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(normal(0.2, 0.5), class="b", coef="speciesanaxyrus_woodhousii")),
#sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
saveRDS(species_site_model, "Models/species_site_model.rds")
species_site_model#call the model to view stats
pp_check(species_site_model, type="stat_grouped", group="species")
pp_check(species_site_model, type="stat_grouped", group="site")
pp_check(species_site_model, type="boxplot")
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0.2, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(normal(0.5, 0.5), class="b", coef="speciesanaxyrus_woodhousii"),
prior(normal(0.5, 0.5), class="b", coef="sitelost_lake"),
prior(normal(0.4,0.5), class="b", coef="sitenab_2")),
#sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
get_prior(virus_copies ~ 1+ site*species, data=site_data, family=hurdle_gamma(link="log"))
#model
species_site_model <- brm(bf(virus_copies ~ 1 + site*species,
hu ~ 1 + site*species),     #This line is added to model the probability of detecting the virus, this makes the detection probability unique for each site.
family=hurdle_gamma(link="log"),
data=site_data,
prior=c(prior(normal(0.2, 0.5), class="b"),
prior(normal(0.3, 0.8), class="Intercept"),
prior(normal(0.5, 0.5), class="b", coef="speciesanaxyrus_woodhousii"),
prior(normal(0.5, 0.5), class="b", coef="sitelost_lake"),
prior(normal(0.4,0.5), class="b", coef="siteNAB_2")),
#sample_prior="only",
iter=1000, chains=1,
file="Models/species_site_model.rds",
file_refit="on_change")
library(tidyverse)
